/*
          # [Composite Migration] Opname Schema & Security Hardening
          [This script creates the tables required for the stock opname workflow and applies a security fix to all existing custom database functions by setting a non-mutable search_path.]

          ## Query Description: 
          This operation is safe and will not affect existing data. It adds two new tables (`stock_opname_sessions`, `stock_opname_items`) and modifies three existing functions to improve security as recommended by Supabase security advisories. No backup is required.
          
          ## Metadata:
          - Schema-Category: ["Structural", "Safe"]
          - Impact-Level: ["Low"]
          - Requires-Backup: false
          - Reversible: true
          
          ## Structure Details:
          - Tables Added: `stock_opname_sessions`, `stock_opname_items`
          - Functions Modified: `handle_new_user`, `get_item_stock`, `get_item_stock_at_location`
          
          ## Security Implications:
          - RLS Status: Enabled on new tables.
          - Policy Changes: Adds policies for new tables.
          - Auth Requirements: Policies are based on `auth.uid()`.
          
          ## Performance Impact:
          - Indexes: Adds indexes to new tables for efficient querying.
          - Triggers: None.
          - Estimated Impact: Low. Improves function performance slightly.
          */

-- 1. Security Hardening: Fix search_path for all functions
ALTER FUNCTION public.handle_new_user() SET search_path = 'public';
ALTER FUNCTION public.get_item_stock(p_item_id integer) SET search_path = 'public';
ALTER FUNCTION public.get_item_stock_at_location(p_item_id integer, p_location_id integer) SET search_path = 'public';


-- 2. Schema for Stock Opname Sessions
CREATE TABLE IF NOT EXISTS public.stock_opname_sessions (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid REFERENCES public.users(id) NOT NULL,
    status text NOT NULL DEFAULT 'pending'::text, -- pending, in_progress, completed, approved
    notes text,
    approved_at timestamp with time zone,
    approved_by uuid REFERENCES public.users(id)
);
COMMENT ON TABLE public.stock_opname_sessions IS 'Header table for each stock counting session.';

-- 3. Schema for Stock Opname Items (Line Items)
CREATE TABLE IF NOT EXISTS public.stock_opname_items (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    session_id bigint REFERENCES public.stock_opname_sessions(id) ON DELETE CASCADE NOT NULL,
    item_id integer REFERENCES public.items(id) NOT NULL,
    location_id integer REFERENCES public.locations(id) NOT NULL,
    system_stock_at_start numeric NOT NULL,
    physical_count numeric,
    discrepancy numeric GENERATED ALWAYS AS (physical_count - system_stock_at_start) STORED,
    cost_price_at_start numeric NOT NULL,
    notes text
);
COMMENT ON TABLE public.stock_opname_items IS 'Individual items being counted in a session.';

-- 4. RLS Policies for Opname Sessions
ALTER TABLE public.stock_opname_sessions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Allow full access to own sessions" ON public.stock_opname_sessions;
CREATE POLICY "Allow full access to own sessions"
ON public.stock_opname_sessions
FOR ALL
USING (auth.uid() = created_by);

-- 5. RLS Policies for Opname Items
ALTER TABLE public.stock_opname_items ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Allow access based on session ownership" ON public.stock_opname_items;
CREATE POLICY "Allow access based on session ownership"
ON public.stock_opname_items
FOR ALL
USING (
  EXISTS (
    SELECT 1
    FROM stock_opname_sessions s
    WHERE s.id = session_id AND s.created_by = auth.uid()
  )
);
